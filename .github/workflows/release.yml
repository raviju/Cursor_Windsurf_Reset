name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v2.1.3

jobs:
  build:
    name: Build for multiple platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            suffix: .exe
            name: windows-amd64
          - goos: windows
            goarch: arm64
            suffix: .exe
            name: windows-arm64
          - goos: darwin
            goarch: amd64
            suffix: ""
            name: macos-amd64
          - goos: darwin
            goarch: arm64
            suffix: ""
            name: macos-arm64
          - goos: linux
            goarch: amd64
            suffix: ""
            name: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: ""
            name: linux-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: |
        go mod download
        go mod verify

    # æ–°å¢ï¼šå®‰è£…Pythonå’Œfonttoolsç”¨äºå­—ä½“å­é›†åŒ–
    - name: Set up Python for font subsetting
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install fonttools for font subsetting
      run: |
        pip install fonttools
        echo "âœ… å·²å®‰è£…å­—ä½“å­é›†åŒ–å·¥å…·"

    # æ–°å¢ï¼šå®‰è£…UPXå‹ç¼©å·¥å…·
    - name: Install UPX
      run: |
        sudo apt-get update
        sudo apt-get install -y upx-ucl
        upx --version
        echo "âœ… å·²å®‰è£…UPXå‹ç¼©å·¥å…·"

    # å®‰è£…å¹³å°ç‰¹å®šçš„æ„å»ºä¾èµ–
    - name: Install build dependencies for Linux
      if: matrix.goos == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-multilib libc6-dev
        # å®‰è£… Fyne æ‰€éœ€çš„ä¾èµ–
        sudo apt-get install -y libgl1-mesa-dev xorg-dev

    # å¢å¼ºWindowsæ„å»ºæ”¯æŒ
    - name: Install cross-compilation tools for Windows
      if: matrix.goos == 'windows'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64
        if [ "${{ matrix.goarch }}" = "arm64" ]; then
          # æ£€æŸ¥ARM64ç¼–è¯‘å™¨æ˜¯å¦å¯ç”¨
          if ! which aarch64-w64-mingw32-gcc > /dev/null; then
            echo "âš ï¸ è­¦å‘Š: Windows ARM64 ç¼–è¯‘å™¨ä¸å¯ç”¨ï¼Œå°è¯•å®‰è£…æ›¿ä»£æ–¹æ¡ˆ..."
            # å°è¯•å®‰è£…æ›¿ä»£æ–¹æ¡ˆï¼Œæ ¹æ®Ubuntuç‰ˆæœ¬å¯èƒ½ä¼šæœ‰ä¸åŒçš„åŒ…å
            sudo apt-get install -y gcc-mingw-w64-aarch64 || true
          fi
        fi

    # å¢å¼ºmacOSæ„å»ºæ”¯æŒ
    - name: Setup macOS cross-compilation (if needed)
      if: matrix.goos == 'darwin'
      run: |
        echo "â„¹ï¸ è®¾ç½®macOSäº¤å‰ç¼–è¯‘ç¯å¢ƒ..."
        # macOSäº¤å‰ç¼–è¯‘é€šå¸¸ä¸éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨ï¼Œä½†éœ€è¦ç‰¹æ®Šå¤„ç†
        # è®°å½•å½“å‰ç¯å¢ƒä»¥ä¾¿è°ƒè¯•
        go env

    # æ›¿æ¢ï¼šä½¿ç”¨Pythonè„šæœ¬ä»æºç ä¸­æå–ä¸­æ–‡å­—ç¬¦
    - name: Extract Chinese characters from source code
      run: |
        echo "ğŸ“ ä»æºç ä¸­æå–ä¸­æ–‡å­—ç¬¦..."
        
        # åˆ›å»ºPythonè„šæœ¬æ¥æå–ä¸­æ–‡å­—ç¬¦
        cat > extract_chinese.py << 'EOF'
        import os
        import re
        import sys

        def is_chinese(c):
            # æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ–‡å­—ç¬¦ï¼ˆUnicodeèŒƒå›´ï¼‰
            return '\u4e00' <= c <= '\u9fff'

        def extract_chinese_from_file(filename):
            chinese_chars = set()
            try:
                with open(filename, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read()
                    # æå–åŒå¼•å·ä¸­çš„å­—ç¬¦ä¸²
                    double_quotes = re.findall(r'"([^"]*)"', content)
                    for s in double_quotes:
                        for c in s:
                            if is_chinese(c):
                                chinese_chars.update(s)
                                break
                    
                    # æå–å•å¼•å·ä¸­çš„å­—ç¬¦ä¸²
                    single_quotes = re.findall(r"'([^']*)'", content)
                    for s in single_quotes:
                        for c in s:
                            if is_chinese(c):
                                chinese_chars.update(s)
                                break
            except Exception as e:
                print(f"è­¦å‘Š: å¤„ç†æ–‡ä»¶ {filename} æ—¶å‡ºé”™: {e}", file=sys.stderr)
            
            return chinese_chars

        def main():
            all_chinese = set()
            count = 0
            
            # é€’å½’éå†æ‰€æœ‰Goæ–‡ä»¶
            for root, _, files in os.walk('.'):
                for file in files:
                    if file.endswith('.go'):
                        file_path = os.path.join(root, file)
                        chinese_in_file = extract_chinese_from_file(file_path)
                        all_chinese.update(chinese_in_file)
                        if chinese_in_file:
                            count += 1
            
            # ç¡®ä¿åŸºæœ¬ASCIIå­—ç¬¦ä¹Ÿè¢«åŒ…å«
            ascii_chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ,.?!@#$%^&*()_+-=[]{}|;:\"'<>/`~"
            all_chars = all_chinese.union(set(ascii_chars))
            
            # å†™å…¥åˆ°æ–‡ä»¶
            with open('chinese_chars.txt', 'w', encoding='utf-8') as f:
                f.write(''.join(all_chars))
            
            print(f"âœ… ä¸­æ–‡å­—ç¬¦æå–å®Œæˆï¼Œå¤„ç†äº† {count} ä¸ªåŒ…å«ä¸­æ–‡çš„æ–‡ä»¶")
            print(f"ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:")
            print(f"- æ€»å­—ç¬¦æ•°: {len(all_chars)}")
            print(f"- ä¸­æ–‡å­—ç¬¦æ•°: {len([c for c in all_chars if is_chinese(c)])}")
            
            # æ‰“å°æ ·ä¾‹ï¼ˆæœ€å¤š20ä¸ªå­—ç¬¦ï¼‰
            sample = ''.join(list(all_chars)[:20])
            print(f"- å­—ç¬¦æ ·ä¾‹: {sample}")

        if __name__ == '__main__':
            main()
        EOF
        
        # æ‰§è¡ŒPythonè„šæœ¬
        python extract_chinese.py
        
        echo "ğŸ“„ ä¸­æ–‡å­—ç¬¦æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
        head -c 100 chinese_chars.txt

    # åŠ å¼ºå­—ä½“å­é›†åŒ–æ­¥éª¤çš„é”™è¯¯å¤„ç†
    - name: Create font subset
      run: |
        echo "ğŸ“ å¼€å§‹å­—ä½“å­é›†åŒ–..."
        
        # æ£€æŸ¥å­—ä½“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "gui/NotoSansSC-Regular.ttf" ]; then
          echo "âŒ é”™è¯¯: å­—ä½“æ–‡ä»¶ä¸å­˜åœ¨: gui/NotoSansSC-Regular.ttf"
          # åˆ—å‡ºç›®å½•å†…å®¹ä»¥è°ƒè¯•
          echo "ç›®å½•å†…å®¹:"
          ls -la gui/
          exit 1
        fi
        
        # æ£€æŸ¥ä¸­æ–‡å­—ç¬¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "chinese_chars.txt" ]; then
          echo "âŒ é”™è¯¯: ä¸­æ–‡å­—ç¬¦æ–‡ä»¶ä¸å­˜åœ¨: chinese_chars.txt"
          exit 1
        fi
        
        # åˆ›å»ºå­—ä½“å­é›†ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        if ! pyftsubset gui/NotoSansSC-Regular.ttf --text-file=chinese_chars.txt --output-file=gui/NotoSansSC-Subset.ttf; then
          echo "âŒ å­—ä½“å­é›†åŒ–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸºæœ¬é€‰é¡¹..."
          # å°è¯•ç®€åŒ–çš„å­é›†åŒ–å‘½ä»¤
          pyftsubset gui/NotoSansSC-Regular.ttf --text="æµ‹è¯•ä¸­æ–‡" --output-file=gui/NotoSansSC-Subset.ttf
        fi
        
        # éªŒè¯å­é›†å­—ä½“æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ ! -f "gui/NotoSansSC-Subset.ttf" ]; then
          echo "âŒ é”™è¯¯: å­é›†å­—ä½“æ–‡ä»¶åˆ›å»ºå¤±è´¥"
          # å¤åˆ¶åŸå§‹å­—ä½“ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
          cp gui/NotoSansSC-Regular.ttf gui/NotoSansSC-Subset.ttf
          echo "âš ï¸ ä½¿ç”¨åŸå§‹å­—ä½“ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ"
        else
          # æ£€æŸ¥å­—ä½“æ–‡ä»¶å¤§å°
          ORIGINAL_SIZE=$(stat -c %s gui/NotoSansSC-Regular.ttf)
          SUBSET_SIZE=$(stat -c %s gui/NotoSansSC-Subset.ttf)
          SAVED_SIZE=$((ORIGINAL_SIZE - SUBSET_SIZE))
          SAVED_PERCENT=$((SAVED_SIZE * 100 / ORIGINAL_SIZE))
          
          echo "ğŸ“Š å­—ä½“æ–‡ä»¶å¤§å°å¯¹æ¯”:"
          echo "- åŸå§‹å­—ä½“: $ORIGINAL_SIZE å­—èŠ‚"
          echo "- å­é›†å­—ä½“: $SUBSET_SIZE å­—èŠ‚"
          echo "- èŠ‚çœç©ºé—´: $SAVED_SIZE å­—èŠ‚ ($SAVED_PERCENT%)"
        fi
        
        # ä¿®æ”¹resources.goæ–‡ä»¶ä»¥ä½¿ç”¨å­é›†å­—ä½“
        if [ -f "gui/resources.go" ]; then
          sed -i 's/NotoSansSC-Regular.ttf/NotoSansSC-Subset.ttf/g' gui/resources.go
          echo "âœ… æ›´æ–°resources.goä½¿ç”¨å­é›†å­—ä½“"
        else
          echo "âŒ é”™è¯¯: resources.goæ–‡ä»¶ä¸å­˜åœ¨"
        fi

    # å¢å¼ºæ„å»ºæ­¥éª¤ï¼Œæ·»åŠ æ›´å¤šé”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 1
      run: |
        echo "ğŸ”¨ å¼€å§‹ä¸º ${{ matrix.goos }}-${{ matrix.goarch }} æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶..."
        
        # è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ
        if [ "${{ matrix.goos }}" = "windows" ]; then
          if [ "${{ matrix.goarch }}" = "amd64" ]; then
            export CC=x86_64-w64-mingw32-gcc
            export CXX=x86_64-w64-mingw32-g++
          elif [ "${{ matrix.goarch }}" = "arm64" ]; then
            # å°è¯•ä½¿ç”¨aarch64ç¼–è¯‘å™¨ï¼Œå¦‚æœä¸å¯ç”¨åˆ™æŠ¥å‘Š
            if which aarch64-w64-mingw32-gcc > /dev/null; then
              export CC=aarch64-w64-mingw32-gcc
              export CXX=aarch64-w64-mingw32-g++
            else
              echo "âš ï¸ è­¦å‘Š: Windows ARM64 ç¼–è¯‘å™¨ä¸å¯ç”¨ï¼Œæ„å»ºå¯èƒ½ä¼šå¤±è´¥"
            fi
          fi
        elif [ "${{ matrix.goos }}" = "darwin" ]; then
          # macOSæ„å»ºå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
          echo "â„¹ï¸ è®¾ç½®macOSæ„å»ºç¯å¢ƒ"
          # å¯¹äºmacOSæ„å»ºï¼Œé€šå¸¸ä¸éœ€è¦è®¾ç½®CC/CXX
        fi
        
        # æ˜¾ç¤ºç¼–è¯‘ç¯å¢ƒä¿¡æ¯
        echo "ğŸ“‹ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯:"
        echo "- GOOS: $GOOS"
        echo "- GOARCH: $GOARCH"
        echo "- CGO_ENABLED: $CGO_ENABLED"
        echo "- CC: ${CC:-æœªè®¾ç½®}"
        echo "- CXX: ${CXX:-æœªè®¾ç½®}"
        
        # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ·»åŠ é¢å¤–çš„ä¼˜åŒ–é€‰é¡¹
        OUTPUT_NAME="Cursor_Windsurf_Reset-${{ matrix.name }}${{ matrix.suffix }}"
        echo "ğŸ”§ æ‰§è¡Œæ„å»ºå‘½ä»¤: go build -ldflags=\"-s -w -X main.version=${{ github.ref_name }}\" -o \"${OUTPUT_NAME}\" main.go"
        
        # å°è¯•æ„å»ºï¼Œå¦‚æœå¤±è´¥åˆ™æä¾›è¯¦ç»†æ—¥å¿—
        if ! go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o "${OUTPUT_NAME}" main.go; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—"
          go build -v -x -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o "${OUTPUT_NAME}" main.go || true
          # æ£€æŸ¥å¸¸è§çš„å¤±è´¥åŸå› 
          echo "ğŸ“‹ è¯Šæ–­ä¿¡æ¯:"
          go env
          echo "âš ï¸ æ„å»ºå¤±è´¥ï¼Œè·³è¿‡åç»­æ­¥éª¤"
          exit 1
        fi
        
        # è®°å½•æ„å»ºå‰çš„æ–‡ä»¶å¤§å°
        ORIGINAL_SIZE=$(stat -c %s "${OUTPUT_NAME}")
        echo "ğŸ“Š åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°: ${ORIGINAL_SIZE} å­—èŠ‚"
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ -f "${OUTPUT_NAME}" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ: ${OUTPUT_NAME}"
          ls -la "${OUTPUT_NAME}"
        else
          echo "âŒ æ„å»ºå¤±è´¥: ${OUTPUT_NAME} æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ä½¿ç”¨UPXå‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶
        echo "ğŸ“¦ å¼€å§‹UPXå‹ç¼©..."
        if ! upx --best "${OUTPUT_NAME}"; then
          echo "âš ï¸ UPXå‹ç¼©å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ™®é€šæ¨¡å¼"
          upx "${OUTPUT_NAME}" || echo "âŒ UPXå‹ç¼©å®Œå…¨å¤±è´¥ï¼Œä½¿ç”¨æœªå‹ç¼©æ–‡ä»¶"
        fi
        
        # è®°å½•å‹ç¼©åçš„æ–‡ä»¶å¤§å°
        COMPRESSED_SIZE=$(stat -c %s "${OUTPUT_NAME}")
        SAVED_SIZE=$((ORIGINAL_SIZE - COMPRESSED_SIZE))
        SAVED_PERCENT=$((SAVED_SIZE * 100 / ORIGINAL_SIZE))
        
        echo "ğŸ“Š å‹ç¼©æ•ˆæœ:"
        echo "- å‹ç¼©å‰: ${ORIGINAL_SIZE} å­—èŠ‚"
        echo "- å‹ç¼©å: ${COMPRESSED_SIZE} å­—èŠ‚"
        echo "- èŠ‚çœç©ºé—´: ${SAVED_SIZE} å­—èŠ‚ (${SAVED_PERCENT}%)"
        
        # åˆ›å»ºä¼˜åŒ–æŒ‡æ ‡æ–‡ä»¶ï¼Œä¾›åç»­å‘å¸ƒæ­¥éª¤ä½¿ç”¨
        echo "${ORIGINAL_SIZE},${COMPRESSED_SIZE},${SAVED_SIZE},${SAVED_PERCENT}" > "${OUTPUT_NAME}.metrics"

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Cursor_Windsurf_Reset-${{ matrix.name }}
        path: |
          Cursor_Windsurf_Reset-${{ matrix.name }}${{ matrix.suffix }}
          Cursor_Windsurf_Reset-${{ matrix.name }}${{ matrix.suffix }}.metrics

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Display structure of downloaded files
      run: |
        echo "ğŸ“ ä¸‹è½½çš„æ–‡ä»¶ç»“æ„:"
        find . -name "Cursor_Windsurf_Reset-*" -type f | sort

    - name: Prepare release files
      run: |
        mkdir -p release-files
        
        # ç§»åŠ¨æ‰€æœ‰æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ° release-files ç›®å½•
        find . -name "Cursor_Windsurf_Reset-*" -type f -executable -o -name "*.exe" | while read file; do
          if [ -f "$file" ]; then
            cp "$file" release-files/
            echo "âœ… å¤åˆ¶æ–‡ä»¶: $file -> release-files/"
          fi
        done
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œæ–‡æ¡£ï¼ˆä¿®æ­£æ–‡ä»¶åï¼‰
        if [ -f "reset_config.json" ]; then
          cp reset_config.json release-files/
          echo "âœ… å¤åˆ¶æ–‡ä»¶: reset_config.json -> release-files/"
        else
          echo "âš ï¸ è­¦å‘Š: reset_config.json ä¸å­˜åœ¨"
        fi
        
        if [ -f "README.md" ]; then
          cp README.md release-files/
          echo "âœ… å¤åˆ¶æ–‡ä»¶: README.md -> release-files/"
        else
          echo "âš ï¸ è­¦å‘Š: README.md ä¸å­˜åœ¨"
        fi
        
        echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶:"
        ls -la release-files/

    # æ–°å¢ï¼šæ”¶é›†æ‰€æœ‰å¹³å°çš„ä¼˜åŒ–æŒ‡æ ‡
    - name: Collect optimization metrics
      id: collect_metrics
      run: |
        echo "ğŸ“Š æ”¶é›†ä¼˜åŒ–æŒ‡æ ‡..."
        TOTAL_ORIGINAL_SIZE=0
        TOTAL_COMPRESSED_SIZE=0
        
        echo "| å¹³å° | åŸå§‹å¤§å° | ä¼˜åŒ–åå¤§å° | èŠ‚çœç©ºé—´ | å‹ç¼©ç‡ |" > optimization_metrics.md
        echo "|------|----------|------------|----------|--------|" >> optimization_metrics.md
        
        # æŸ¥æ‰¾æ‰€æœ‰æŒ‡æ ‡æ–‡ä»¶
        METRICS_FILES=$(find . -name "*.metrics" 2>/dev/null || echo "")
        
        if [ -z "$METRICS_FILES" ]; then
          echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°æŒ‡æ ‡æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆä¼˜åŒ–æŠ¥å‘Š"
          echo "| æ— æ•°æ® | - | - | - | - |" >> optimization_metrics.md
        else
          while read metrics_file; do
            PLATFORM=$(basename $metrics_file .metrics)
            
            if [ ! -f "$metrics_file" ]; then
              echo "âš ï¸ è­¦å‘Š: æŒ‡æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $metrics_file"
              continue
            fi
            
            METRICS=$(cat $metrics_file)
            
            # å¤„ç†å¯èƒ½çš„æ ¼å¼é”™è¯¯
            if [[ $METRICS != *","* ]]; then
              echo "âš ï¸ è­¦å‘Š: æŒ‡æ ‡æ–‡ä»¶æ ¼å¼é”™è¯¯: $metrics_file"
              continue
            fi
            
            IFS=',' read -r ORIGINAL_SIZE COMPRESSED_SIZE SAVED_SIZE SAVED_PERCENT <<< "$METRICS"
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸè§£ææ•°å€¼
            if [[ ! "$ORIGINAL_SIZE" =~ ^[0-9]+$ ]]; then
              echo "âš ï¸ è­¦å‘Š: æ— æ³•è§£æåŸå§‹å¤§å°: $ORIGINAL_SIZE"
              continue
            fi
            
            ORIGINAL_SIZE_MB=$(echo "scale=2; $ORIGINAL_SIZE/1048576" | bc)
            COMPRESSED_SIZE_MB=$(echo "scale=2; $COMPRESSED_SIZE/1048576" | bc)
            SAVED_SIZE_MB=$(echo "scale=2; $SAVED_SIZE/1048576" | bc)
            
            echo "| $PLATFORM | ${ORIGINAL_SIZE_MB} MB | ${COMPRESSED_SIZE_MB} MB | ${SAVED_SIZE_MB} MB | ${SAVED_PERCENT}% |" >> optimization_metrics.md
            
            TOTAL_ORIGINAL_SIZE=$((TOTAL_ORIGINAL_SIZE + ORIGINAL_SIZE))
            TOTAL_COMPRESSED_SIZE=$((TOTAL_COMPRESSED_SIZE + COMPRESSED_SIZE))
          done <<< "$METRICS_FILES"
          
          # åªæœ‰åœ¨æœ‰æ•°æ®çš„æƒ…å†µä¸‹æ‰è®¡ç®—æ€»è®¡
          if [ $TOTAL_ORIGINAL_SIZE -gt 0 ]; then
            TOTAL_SAVED_SIZE=$((TOTAL_ORIGINAL_SIZE - TOTAL_COMPRESSED_SIZE))
            TOTAL_SAVED_PERCENT=$((TOTAL_SAVED_SIZE * 100 / TOTAL_ORIGINAL_SIZE))
            TOTAL_ORIGINAL_SIZE_MB=$(echo "scale=2; $TOTAL_ORIGINAL_SIZE/1048576" | bc)
            TOTAL_COMPRESSED_SIZE_MB=$(echo "scale=2; $TOTAL_COMPRESSED_SIZE/1048576" | bc)
            TOTAL_SAVED_SIZE_MB=$(echo "scale=2; $TOTAL_SAVED_SIZE/1048576" | bc)
            
            echo "| **æ€»è®¡** | **${TOTAL_ORIGINAL_SIZE_MB} MB** | **${TOTAL_COMPRESSED_SIZE_MB} MB** | **${TOTAL_SAVED_SIZE_MB} MB** | **${TOTAL_SAVED_PERCENT}%** |" >> optimization_metrics.md
          fi
        fi
        
        echo "âœ… ä¼˜åŒ–æŒ‡æ ‡æ”¶é›†å®Œæˆ"
        cat optimization_metrics.md

    - name: Generate release notes
      id: release_notes
      run: |
        TAG_NAME=${{ github.ref_name }}
        echo "ğŸ‰ Cursor & Windsurf é‡ç½®å·¥å…· ${TAG_NAME}" > release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ“¦ ä¸‹è½½è¯´æ˜" >> release_notes.md
        echo "" >> release_notes.md
        echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼š" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Windows ç”¨æˆ·" >> release_notes.md
        echo "- **Windows x64**: \`Cursor_Windsurf_Reset-windows-amd64.exe\`" >> release_notes.md
        echo "- **Windows ARM64**: \`Cursor_Windsurf_Reset-windows-arm64.exe\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### macOS ç”¨æˆ·" >> release_notes.md
        echo "- **Intel Mac**: \`Cursor_Windsurf_Reset-macos-amd64\`" >> release_notes.md
        echo "- **Apple Silicon (M1/M2)**: \`Cursor_Windsurf_Reset-macos-arm64\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Linux ç”¨æˆ·" >> release_notes.md
        echo "- **Linux x64**: \`Cursor_Windsurf_Reset-linux-amd64\`" >> release_notes.md
        echo "- **Linux ARM64**: \`Cursor_Windsurf_Reset-linux-arm64\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸš€ ä½¿ç”¨æ–¹æ³•" >> release_notes.md
        echo "" >> release_notes.md
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶" >> release_notes.md
        echo "2. ä¸‹è½½ \`reset_config.json\` é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰" >> release_notes.md
        echo "3. åŒå‡»è¿è¡Œï¼ˆWindowsï¼‰æˆ–åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ" >> release_notes.md
        echo "4. è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ \`README.md\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## âš ï¸ æ³¨æ„äº‹é¡¹" >> release_notes.md
        echo "" >> release_notes.md
        echo "- ä½¿ç”¨å‰è¯·å¤‡ä»½é‡è¦æ•°æ®" >> release_notes.md
        echo "- ç¡®ä¿ Cursor å’Œ Windsurf åº”ç”¨å·²å®Œå…¨å…³é—­" >> release_notes.md
        echo "- é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™" >> release_notes.md
        echo "- macOS å’Œ Linux ç”¨æˆ·å¯èƒ½éœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ï¼š\`chmod +x Cursor_Windsurf_Reset-*\`" >> release_notes.md
        echo "" >> release_notes.md
        
        # æ–°å¢ï¼šæ·»åŠ ä¼˜åŒ–ä¿¡æ¯åˆ°å‘å¸ƒè¯´æ˜
        echo "## ğŸ“Š ä¼˜åŒ–ä¿¡æ¯" >> release_notes.md
        echo "" >> release_notes.md
        echo "æ­¤ç‰ˆæœ¬åº”ç”¨äº†å¤šé¡¹ä¼˜åŒ–æŠ€æœ¯ä»¥å‡å°äºŒè¿›åˆ¶æ–‡ä»¶ä½“ç§¯ï¼š" >> release_notes.md
        echo "" >> release_notes.md
        echo "1. å­—ä½“å­é›†åŒ–ï¼šåªä¿ç•™åº”ç”¨ä¸­ä½¿ç”¨çš„ä¸­æ–‡å­—ç¬¦" >> release_notes.md
        echo "2. UPXå‹ç¼©ï¼šä½¿ç”¨é«˜æ•ˆå‹ç¼©ç®—æ³•å‡å°å¯æ‰§è¡Œæ–‡ä»¶ä½“ç§¯" >> release_notes.md
        echo "3. é“¾æ¥ä¼˜åŒ–ï¼šä½¿ç”¨æ›´ä¼˜åŒ–çš„ç¼–è¯‘é€‰é¡¹" >> release_notes.md
        echo "" >> release_notes.md
        echo "### ä¼˜åŒ–æ•ˆæœ" >> release_notes.md
        echo "" >> release_notes.md
        cat optimization_metrics.md >> release_notes.md
        echo "" >> release_notes.md
        
        echo "## ğŸ”§ æŠ€æœ¯ä¿¡æ¯" >> release_notes.md
        echo "" >> release_notes.md
        echo "- **ç‰ˆæœ¬**: ${TAG_NAME}" >> release_notes.md
        echo "- **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
        echo "- **Go ç‰ˆæœ¬**: 1.21" >> release_notes.md
        echo "- **GUI æ¡†æ¶**: Fyne v2" >> release_notes.md
        
        echo "ğŸ“ ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜:"
        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "Cursor & Windsurf é‡ç½®å·¥å…· ${{ github.ref_name }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          release-files/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release summary
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¦ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡ç­¾**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š ä¼˜åŒ–æ•ˆæœ" >> $GITHUB_STEP_SUMMARY
        cat optimization_metrics.md >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ”— é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æŸ¥çœ‹å‘å¸ƒé¡µé¢](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
        echo "- [ä¸‹è½½æ–‡ä»¶](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY