name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0, v2.1.3

jobs:
  build:
    name: Build for multiple platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            suffix: .exe
            name: windows-amd64
          - goos: windows
            goarch: arm64
            suffix: .exe
            name: windows-arm64
          - goos: darwin
            goarch: amd64
            suffix: ""
            name: macos-amd64
          - goos: darwin
            goarch: arm64
            suffix: ""
            name: macos-arm64
          - goos: linux
            goarch: amd64
            suffix: ""
            name: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: ""
            name: linux-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: |
        go mod download
        go mod verify

    - name: Install build dependencies for Linux
      if: matrix.goos == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-multilib libc6-dev
        # å®‰è£… Fyne æ‰€éœ€çš„ä¾èµ–
        sudo apt-get install -y libgl1-mesa-dev xorg-dev

    - name: Install cross-compilation tools for Windows
      if: matrix.goos == 'windows'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mingw-w64

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 1
      run: |
        # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
        if [ "${{ matrix.goos }}" = "windows" ]; then
          if [ "${{ matrix.goarch }}" = "amd64" ]; then
            export CC=x86_64-w64-mingw32-gcc
            export CXX=x86_64-w64-mingw32-g++
          else
            export CC=aarch64-w64-mingw32-gcc
            export CXX=aarch64-w64-mingw32-g++
          fi
        fi
        
        # æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
        OUTPUT_NAME="Cursor_Windsurf_Reset-${{ matrix.name }}${{ matrix.suffix }}"
        go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o "${OUTPUT_NAME}" main.go
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ -f "${OUTPUT_NAME}" ]; then
          echo "âœ… æž„å»ºæˆåŠŸ: ${OUTPUT_NAME}"
          ls -la "${OUTPUT_NAME}"
        else
          echo "âŒ æž„å»ºå¤±è´¥: ${OUTPUT_NAME}"
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Cursor_Windsurf_Reset-${{ matrix.name }}
        path: Cursor_Windsurf_Reset-${{ matrix.name }}${{ matrix.suffix }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Display structure of downloaded files
      run: |
        echo "ðŸ“ ä¸‹è½½çš„æ–‡ä»¶ç»“æž„:"
        find . -name "Cursor_Windsurf_Reset-*" -type f | sort

    - name: Prepare release files
      run: |
        mkdir -p release-files
        
        # ç§»åŠ¨æ‰€æœ‰æž„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ° release-files ç›®å½•
        find . -name "Cursor_Windsurf_Reset-*" -type f -executable -o -name "*.exe" | while read file; do
          if [ -f "$file" ]; then
            cp "$file" release-files/
            echo "âœ… å¤åˆ¶æ–‡ä»¶: $file -> release-files/"
          fi
        done
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œæ–‡æ¡£
        cp cleaner_config.json release-files/
        cp README.md release-files/
        
        echo "ðŸ“¦ å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶:"
        ls -la release-files/

    - name: Generate release notes
      id: release_notes
      run: |
        TAG_NAME=${{ github.ref_name }}
        echo "ðŸŽ‰ Cursor & Windsurf é‡ç½®å·¥å…· ${TAG_NAME}" > release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> release_notes.md
        echo "" >> release_notes.md
        echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼š" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Windows ç”¨æˆ·" >> release_notes.md
        echo "- **Windows x64**: \`Cursor_Windsurf_Reset-windows-amd64.exe\`" >> release_notes.md
        echo "- **Windows ARM64**: \`Cursor_Windsurf_Reset-windows-arm64.exe\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### macOS ç”¨æˆ·" >> release_notes.md
        echo "- **Intel Mac**: \`Cursor_Windsurf_Reset-macos-amd64\`" >> release_notes.md
        echo "- **Apple Silicon (M1/M2)**: \`Cursor_Windsurf_Reset-macos-arm64\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Linux ç”¨æˆ·" >> release_notes.md
        echo "- **Linux x64**: \`Cursor_Windsurf_Reset-linux-amd64\`" >> release_notes.md
        echo "- **Linux ARM64**: \`Cursor_Windsurf_Reset-linux-arm64\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸš€ ä½¿ç”¨æ–¹æ³•" >> release_notes.md
        echo "" >> release_notes.md
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶" >> release_notes.md
        echo "2. ä¸‹è½½ \`cleaner_config.json\` é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰" >> release_notes.md
        echo "3. åŒå‡»è¿è¡Œï¼ˆWindowsï¼‰æˆ–åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ" >> release_notes.md
        echo "4. è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒ \`README.md\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## âš ï¸ æ³¨æ„äº‹é¡¹" >> release_notes.md
        echo "" >> release_notes.md
        echo "- ä½¿ç”¨å‰è¯·å¤‡ä»½é‡è¦æ•°æ®" >> release_notes.md
        echo "- ç¡®ä¿ Cursor å’Œ Windsurf åº”ç”¨å·²å®Œå…¨å…³é—­" >> release_notes.md
        echo "- é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™" >> release_notes.md
        echo "- macOS å’Œ Linux ç”¨æˆ·å¯èƒ½éœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ï¼š\`chmod +x Cursor_Windsurf_Reset-*\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ”§ æŠ€æœ¯ä¿¡æ¯" >> release_notes.md
        echo "" >> release_notes.md
        echo "- **ç‰ˆæœ¬**: ${TAG_NAME}" >> release_notes.md
        echo "- **æž„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
        echo "- **Go ç‰ˆæœ¬**: 1.21" >> release_notes.md
        echo "- **GUI æ¡†æž¶**: Fyne v2" >> release_notes.md
        
        echo "ðŸ“ ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜Ž:"
        cat release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "Cursor & Windsurf é‡ç½®å·¥å…· ${{ github.ref_name }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          release-files/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release summary
      run: |
        echo "ðŸŽ‰ å‘å¸ƒå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ ‡ç­¾**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æŸ¥çœ‹å‘å¸ƒé¡µé¢](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
        echo "- [ä¸‹è½½æ–‡ä»¶](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY